# ğŸ“Š Arquitetura do Checkout - Diagrama Visual
## ğŸ” Checkout com AutenticaÃ§Ã£o ObrigatÃ³ria

## 1. Fluxo de Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APLICAÃ‡ÃƒO                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     CartPage                              â”‚   â”‚
â”‚  â”‚  - Exibe itens do carrinho                               â”‚   â”‚
â”‚  â”‚  - BotÃ£o "Finalizar Compra"                              â”‚   â”‚
â”‚  â”‚  - VERIFICA AUTENTICAÃ‡ÃƒO âœ…                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                             â”‚
â”‚                     â”‚ isAuthenticated?                            â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚          â”‚                     â”‚                                 â”‚
â”‚         NÃƒO                   SIM                                â”‚
â”‚          â”‚                     â”‚                                 â”‚
â”‚          â–¼                     â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Redirect para   â”‚  â”‚     CheckoutModal (Modal)           â”‚   â”‚
â”‚  â”‚ /login          â”‚  â”‚  - PrÃ©-preenche dados do usuÃ¡rio    â”‚   â”‚
â”‚  â”‚                 â”‚  â”‚  - Coleta: EndereÃ§o de entrega      â”‚   â”‚
â”‚  â”‚ + from: /cart   â”‚  â”‚  - ValidaÃ§Ã£o de campos              â”‚   â”‚
â”‚  â”‚ + message       â”‚  â”‚  - Resumo do pedido inline          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - BotÃ£o: Continuar                 â”‚   â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                           â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                            â–¼                   â–¼                 â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                   â”‚ createOrder      â”‚  â”‚ createPaymentIntent â”‚ â”‚
â”‚                   â”‚ (GraphQL)        â”‚  â”‚ (GraphQL)           â”‚ â”‚
â”‚                   â”‚ ğŸ”’ Autenticado   â”‚  â”‚ ğŸ”’ Autenticado      â”‚ â”‚
â”‚                   â”‚                  â”‚  â”‚                     â”‚ â”‚
â”‚                   â”‚ Input:           â”‚  â”‚ Input:              â”‚ â”‚
â”‚                   â”‚ - addressId      â”‚  â”‚ - orderId           â”‚ â”‚
â”‚                   â”‚ - JWT Token      â”‚  â”‚ - JWT Token         â”‚ â”‚
â”‚                   â”‚                  â”‚  â”‚                     â”‚ â”‚
â”‚                   â”‚ Output:          â”‚  â”‚ Output:             â”‚ â”‚
â”‚                   â”‚ - orderId        â”‚  â”‚ - clientSecret      â”‚ â”‚
â”‚                   â”‚ - orderNumber    â”‚  â”‚ - paymentIntentId   â”‚ â”‚
â”‚                   â”‚ - order          â”‚  â”‚ - amount            â”‚ â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                  â”‚          â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â–¼                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚     CheckoutPage                   â”‚                 â”‚
â”‚         â”‚                                    â”‚                 â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                 â”‚
â”‚         â”‚  â”‚ Progress â”‚   â”‚ Header   â”‚      â”‚                 â”‚
â”‚         â”‚  â”‚ Stepper  â”‚   â”‚ (Dadosâœ“) â”‚      â”‚                 â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                 â”‚
â”‚         â”‚                                    â”‚                 â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚         â”‚  â”‚                              â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚  OrderSummary (Direita)      â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚  - Itens do pedido           â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚  - Subtotal                  â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚  - Frete                     â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚  - Total                     â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚                              â”‚  â”‚                 â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚         â”‚                                    â”‚                 â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚         â”‚  â”‚                              â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚ StripePaymentForm (Esq)      â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚ - CardElement                â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚ - ValidaÃ§Ã£o                  â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚ - BotÃ£o \"Processar\"          â”‚  â”‚                 â”‚
â”‚         â”‚  â”‚                              â”‚  â”‚                 â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚         â”‚               â”‚                    â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                         â”‚                                      â”‚
â”‚                         â–¼                                      â”‚
â”‚              confirmCardPayment()                              â”‚
â”‚              (Stripe.js)                                       â”‚
â”‚                  â”‚                                            â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚       â”‚                     â”‚                                 â”‚
â”‚    Success              Error                                 â”‚
â”‚       â”‚                     â”‚                                 â”‚
â”‚       â–¼                     â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   â”‚ Mutationâ”‚            â”‚ Mostrar â”‚                         â”‚
â”‚   â”‚Process- â”‚            â”‚ Erro    â”‚                         â”‚
â”‚   â”‚Stripe   â”‚            â”‚ GraphQL â”‚                         â”‚
â”‚   â”‚Payment  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚ OrderConfirmationPage           â”‚                      â”‚
â”‚   â”‚ ğŸ”’ Requer AutenticaÃ§Ã£o           â”‚                      â”‚
â”‚   â”‚ - Ãcone de sucesso              â”‚                      â”‚
â”‚   â”‚ - NÃºmero do pedido              â”‚                      â”‚
â”‚   â”‚ - Status: PAID âœ“                â”‚                      â”‚
â”‚   â”‚ - Dados de entrega              â”‚                      â”‚
â”‚   â”‚ - Itens confirmados             â”‚                      â”‚
â”‚   â”‚ - Associado ao usuÃ¡rio          â”‚                      â”‚
â”‚   â”‚                                 â”‚                      â”‚
â”‚   â”‚ BotÃµes:                         â”‚                      â”‚
â”‚   â”‚ [Ver Meus Pedidos] [Continuar]  â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚            â”‚              â”‚                                  â”‚
â”‚            â–¼              â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚Meus Pedidos  â”‚   â”‚Voltar Home   â”‚                      â”‚
â”‚   â”‚OrdersPage    â”‚   â”‚HomePage      â”‚                      â”‚
â”‚   â”‚ğŸ”’ Autenticadoâ”‚   â”‚              â”‚                      â”‚
â”‚   â”‚- HistÃ³rico   â”‚   â”‚- Novos itens â”‚                      â”‚
â”‚   â”‚- Detalhes    â”‚   â”‚- PromoÃ§Ãµes   â”‚                      â”‚
â”‚   â”‚- Status      â”‚   â”‚              â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Estrutura de Dados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AuthenticatedCheckoutInput (Form)                  â”‚
â”‚                   ğŸ”’ Requer Login                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ userId: string              (do JWT Token)                 â”‚
â”‚ â€¢ addressId: string           (endereÃ§o salvo selecionado)  â”‚
â”‚ â€¢ notes?: string              (Opcional)                    â”‚
â”‚                                                             â”‚
â”‚ Dados do UsuÃ¡rio (prÃ©-carregados):                          â”‚
â”‚ â€¢ customerName: string        (do User.name)                â”‚
â”‚ â€¢ customerEmail: string       (do User.email)               â”‚
â”‚ â€¢ customerPhone: string       (do User.phone)               â”‚
â”‚                                                             â”‚
â”‚ Dados do EndereÃ§o (prÃ©-carregados):                         â”‚
â”‚ â€¢ street: string              (do Address.street)           â”‚
â”‚ â€¢ city: string                (do Address.city)             â”‚
â”‚ â€¢ state: string               (do Address.state)            â”‚
â”‚ â€¢ zipCode: string             (do Address.zipCode)          â”‚
â”‚ â€¢ country: string             (do Address.country)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Order (BD)                               â”‚
â”‚                ğŸ”’ Vinculado ao UsuÃ¡rio                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ id: string                  (UUID)                        â”‚
â”‚ â€¢ userId: string              (referÃªncia User)             â”‚
â”‚ â€¢ orderNumber: string         (#123456)                     â”‚
â”‚ â€¢ status: string              (PENDING)                     â”‚
â”‚ â€¢ totalAmount: number         (R$ 199.90)                   â”‚
â”‚ â€¢ shippingCost: number        (R$ 15.00)                    â”‚
â”‚ â€¢ shippingAddress: Address    (cÃ³pia do endereÃ§o)           â”‚
â”‚ â€¢ items: OrderItem[]                                        â”‚
â”‚   â””â”€ OrderItem:                                             â”‚
â”‚      â€¢ product.title: string                                â”‚
â”‚      â€¢ quantity: number                                     â”‚
â”‚      â€¢ totalPrice: number                                   â”‚
â”‚ â€¢ user: User                  (relacionamento)              â”‚
â”‚ â€¢ createdAt: date                                           â”‚
â”‚ â€¢ updatedAt: date                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PaymentIntentResponse (Stripe)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ paymentIntentId: string   (pi_1234567890)                â”‚
â”‚ â€¢ clientSecret: string      (pi_...secret_...)             â”‚
â”‚ â€¢ status: string            (requires_payment_method)       â”‚
â”‚ â€¢ amount: number            (19990)                         â”‚
â”‚ â€¢ currency: string          (brl)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Stripe Payment Confirmation                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ paymentMethod:                                             â”‚
â”‚   â””â”€ card:                                                  â”‚
â”‚      â€¢ brand: string (visa)                                 â”‚
â”‚      â€¢ last4: string (4242)                                 â”‚
â”‚      â€¢ exp_month/year                                       â”‚
â”‚ â€¢ status: string (succeeded / requires_action)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            StripePaymentResponse (Backend)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ success: boolean            (true)                        â”‚
â”‚ â€¢ message: string             (Payment successful)          â”‚
â”‚ â€¢ orderId: string             (UUID)                        â”‚
â”‚ â€¢ paymentIntentId: string     (pi_...)                      â”‚
â”‚ â€¢ status: string              (PAID)                        â”‚
â”‚ â€¢ amount: number              (19990)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Fluxo de RequisiÃ§Ãµes HTTP/GraphQL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (React)                         â”‚
â”‚                 ğŸ”’ JWT Token no Header                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. createOrder Mutation (Autenticado)
         â”‚    POST /graphql
         â”‚    Headers: {
         â”‚      Authorization: "Bearer <JWT_TOKEN>"
         â”‚    }
         â”‚    {
         â”‚      query: CREATE_ORDER
         â”‚      variables: {
         â”‚        input: {
         â”‚          addressId,
         â”‚          notes
         â”‚        }
         â”‚      }
         â”‚    }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND (GraphQL)                          â”‚
â”‚  - Valida JWT Token âœ…                                       â”‚
â”‚  - Extrai userId do token                                   â”‚
â”‚  - Busca dados do usuÃ¡rio (nome, email, phone)              â”‚
â”‚  - Busca endereÃ§o pelo addressId                            â”‚
â”‚  - Valida se endereÃ§o pertence ao usuÃ¡rio                   â”‚
â”‚  - Busca itens do carrinho do usuÃ¡rio                       â”‚
â”‚  - Calcula totais                                           â”‚
â”‚  - Cria pedido no BD (status: PENDING)                      â”‚
â”‚  - Associa pedido ao usuÃ¡rio                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response:
         â”‚ {
         â”‚   createOrder: {
         â”‚     id,
         â”‚     orderNumber,
         â”‚     items,
         â”‚     totalAmount,
         â”‚     shippingCost,
         â”‚     shippingAddress,
         â”‚     user { name, email }
         â”‚   }
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. createPaymentIntent Mutation (Autenticado)               â”‚
â”‚    POST /graphql                                            â”‚
â”‚    Headers: {                                               â”‚
â”‚      Authorization: "Bearer <JWT_TOKEN>"                    â”‚
â”‚    }                                                        â”‚
â”‚    {                                                        â”‚
â”‚      query: CREATE_PAYMENT_INTENT                           â”‚
â”‚      variables: { orderId }                                 â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND (GraphQL)                          â”‚
â”‚  - Valida JWT Token âœ…                                       â”‚
â”‚  - Extrai userId do token                                   â”‚
â”‚  - Consulta pedido (valida existÃªncia)                      â”‚
â”‚  - Verifica se pedido pertence ao usuÃ¡rio âœ…                 â”‚
â”‚  - Chama Stripe API: create payment intent                  â”‚
â”‚  - Retorna clientSecret                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response:
         â”‚ {
         â”‚   createPaymentIntent: {
         â”‚     paymentIntentId,
         â”‚     clientSecret,
         â”‚     amount,
         â”‚     currency
         â”‚   }
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. confirmCardPayment (Stripe.js)                           â”‚
â”‚    stripe.confirmCardPayment(clientSecret, {               â”‚
â”‚      payment_method: {                                      â”‚
â”‚        card: cardElement                                    â”‚
â”‚      }                                                      â”‚
â”‚    })                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STRIPE SERVERS                             â”‚
â”‚  - Valida dados do cartÃ£o                                   â”‚
â”‚  - Processa pagamento                                       â”‚
â”‚  - Retorna status                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response: {
         â”‚   paymentIntent: {
         â”‚     status: 'succeeded',
         â”‚     id: 'pi_...'
         â”‚   }
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. processStripePayment Mutation (Autenticado)              â”‚
â”‚    POST /graphql                                            â”‚
â”‚    Headers: {                                               â”‚
â”‚      Authorization: "Bearer <JWT_TOKEN>"                    â”‚
â”‚    }                                                        â”‚
â”‚    {                                                        â”‚
â”‚      query: PROCESS_STRIPE_PAYMENT                          â”‚
â”‚      variables: {                                           â”‚
â”‚        paymentIntentId,                                     â”‚
â”‚        orderId                                              â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND (GraphQL)                          â”‚
â”‚  - Valida JWT Token âœ…                                       â”‚
â”‚  - Extrai userId do token                                   â”‚
â”‚  - Valida paymentIntent com Stripe                          â”‚
â”‚  - Verifica se pedido pertence ao usuÃ¡rio âœ…                 â”‚
â”‚  - Atualiza status do pedido (PAID)                         â”‚
â”‚  - Envia email de confirmaÃ§Ã£o para user.email               â”‚
â”‚  - Retorna confirmaÃ§Ã£o                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response:
         â”‚ {
         â”‚   processStripePayment: {
         â”‚     success: true,
         â”‚     orderId,
         â”‚     status: 'PAID'
         â”‚   }
         â”‚ }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. NavegaÃ§Ã£o para /order-confirmation/:orderId             â”‚
â”‚    ğŸ”’ Rota Protegida (Requer AutenticaÃ§Ã£o)                  â”‚
â”‚    State:                                                   â”‚
â”‚    {                                                        â”‚
â”‚      order: Order,                                          â”‚
â”‚      paymentIntentId,                                       â”‚
â”‚      user: {                                                â”‚
â”‚        name,                                                â”‚
â”‚        email                                                â”‚
â”‚      },                                                     â”‚
â”‚      shippingAddress                                        â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Alternativa: Query myOrders (HistÃ³rico)                 â”‚
â”‚    POST /graphql                                            â”‚
â”‚    Headers: {                                               â”‚
â”‚      Authorization: "Bearer <JWT_TOKEN>"                    â”‚
â”‚    }                                                        â”‚
â”‚    {                                                        â”‚
â”‚      query: MY_ORDERS                                       â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND (GraphQL)                          â”‚
â”‚  - Valida JWT Token âœ…                                       â”‚
â”‚  - Extrai userId do token                                   â”‚
â”‚  - Busca todos os pedidos do usuÃ¡rio                        â”‚
â”‚  - Ordena por data (mais recentes primeiro)                 â”‚
â”‚  - Retorna lista de pedidos                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Ciclo de Vida dos Componentes

```
CartPage (Inicial)
  â”‚
  â”œâ”€ useAuth() â†’ { isAuthenticated, user } ğŸ”’
  â”œâ”€ useState(showCheckout: false)
  â”œâ”€ useState(cart items)
  â”œâ”€ useMutation(createOrder)
  â”œâ”€ useMutation(createPaymentIntent)
  â””â”€ Renderiza: botÃ£o "Finalizar Compra"
       â”‚
       â””â”€ onClick â†’ handleCheckoutClick()
            â”‚
            â”œâ”€ if (!isAuthenticated)
            â”‚   â””â”€ navigate('/login', { from: '/cart' }) âŒ
            â”‚       â””â”€ UsuÃ¡rio faz login
            â”‚           â””â”€ Retorna para /cart
            â”‚               â””â”€ Tenta novamente âœ“
            â”‚
            â””â”€ if (isAuthenticated)
                â””â”€ setShowCheckout(true) âœ…
                     â”‚
                     â–¼
                CheckoutModal (Abre)
                  â”‚
                  â”œâ”€ PrÃ©-carrega dados do usuÃ¡rio:
                  â”‚  â”œâ”€ user.name
                  â”‚  â”œâ”€ user.email
                  â”‚  â””â”€ user.phone
                  â”‚
                  â”œâ”€ useQuery(GET_MY_ADDRESSES) ğŸ”’
                  â”‚  â””â”€ Lista endereÃ§os salvos
                  â”‚
                  â”œâ”€ useState(selectedAddressId)
                  â”œâ”€ useState(notes)
                  â”œâ”€ useState(errors)
                  â”œâ”€ useState(loading)
                  â”‚
                  â””â”€ handleSubmit()
                       â”‚
                       â”œâ”€ ValidaÃ§Ã£o de campos
                       â”‚  â””â”€ Se erro: mostrar erro
                       â”‚
                       â”œâ”€ createOrder mutation ğŸ”’
                       â”‚  â”œâ”€ Input: addressId, notes
                       â”‚  â”œâ”€ JWT Token no header
                       â”‚  â””â”€ orderId retornado
                       â”‚
                       â”œâ”€ createPaymentIntent mutation ğŸ”’
                       â”‚  â”œâ”€ Input: orderId
                       â”‚  â”œâ”€ JWT Token no header
                       â”‚  â””â”€ clientSecret retornado
                       â”‚
                       â””â”€ navigate('/checkout/[orderId]', {state: {order, paymentIntent}})
                   â”‚
                   â–¼
              CheckoutPage (Mount)
                â”‚
                â”œâ”€ ğŸ”’ PrivateRoute (verifica autenticaÃ§Ã£o)
                â”‚   â””â”€ Se nÃ£o autenticado â†’ redirect /login
                â”‚
                â”œâ”€ useAuth() â†’ { user, token }
                â”œâ”€ useParams() â†’ orderId
                â”œâ”€ useLocation() â†’ state com order
                â”œâ”€ useState(error)
                â”œâ”€ useState(loading)
                â”œâ”€ useMutation(processStripePayment) ğŸ”’
                â””â”€ Renderiza:
                     â”‚
                     â”œâ”€ Elements provider
                     â”‚  â””â”€ loadStripe(publishableKey)
                     â”‚
                     â”œâ”€ Progress Stepper
                     â”‚
                     â”œâ”€ OrderSummary (componente)
                     â”‚  â””â”€ Exibe: items, subtotal, frete, total
                     â”‚
                     â””â”€ StripePaymentForm (componente)
                         â”‚
                         â”œâ”€ CardElement do Stripe
                         â”œâ”€ useStripe() hook
                         â”œâ”€ useElements() hook
                         â”‚
                         â””â”€ handleSubmit()
                              â”‚
                              â”œâ”€ stripe.confirmCardPayment(clientSecret)
                              â”‚
                              â”œâ”€ Se sucesso:
                              â”‚  â””â”€ processStripePayment mutation
                              â”‚
                              â””â”€ navigate('/order-confirmation/[orderId]', {state})
                                   â”‚
                                   â–¼
                              OrderConfirmationPage (Mount)
                                â”‚
                                â”œâ”€ ğŸ”’ PrivateRoute (verifica autenticaÃ§Ã£o)
                                â”‚   â””â”€ Se nÃ£o autenticado â†’ redirect /login
                                â”‚
                                â”œâ”€ useAuth() â†’ { user }
                                â”œâ”€ useParams() â†’ orderId
                                â”œâ”€ useLocation() â†’ state
                                â”œâ”€ useNavigate()
                                â”‚
                                â”œâ”€ Opcional: useQuery(GET_ORDER) ğŸ”’
                                â”‚   â””â”€ Busca detalhes do pedido se state vazio
                                â”‚
                                â””â”€ Renderiza:
                                     â”œâ”€ Ãcone de sucesso (animado)
                                     â”œâ”€ SaudaÃ§Ã£o: "Obrigado, {user.name}!"
                                     â”œâ”€ NÃºmero do pedido
                                     â”œâ”€ Status: PAID âœ“
                                     â”œâ”€ Dados de entrega
                                     â”œâ”€ Items do pedido
                                     â”œâ”€ Totais
                                     â”œâ”€ ConfirmaÃ§Ã£o enviada para {user.email}
                                     â”‚
                                     â””â”€ BotÃµes:
                                         â”œâ”€ [Ver Meus Pedidos]
                                         â”‚   â””â”€ navigate('/orders') ğŸ”’
                                         â”‚
                                         â””â”€ [Continuar Comprando]
                                             â””â”€ navigate('/')
```

---

## 5. Estados e TransiÃ§Ãµes

```
Estados PossÃ­veis do Checkout:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INIT            â”‚  Inicial
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ onClick "Finalizar Compra"
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHECK_AUTH      â”‚  Verificando autenticaÃ§Ã£o ğŸ”’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
   NÃƒO       SIM
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REDIRECTâ”‚ â”‚  MODAL_OPEN      â”‚  Modal aberto, dados prÃ©-carregados
â”‚ /login  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ ValidaÃ§Ã£o falha
                     â”œâ”€> mostrar erro, permanecer em MODAL_OPEN
                     â”‚
                     â”‚ handleSubmit() + createOrder ğŸ”’
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  CREATING_ORDER  â”‚  Loading - criando pedido (autenticado)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Erro
                       â”œâ”€> mostrar erro, voltar para MODAL_OPEN
                       â”‚
                       â”‚ Sucesso - orderId recebido
                       â”œâ”€> createPaymentIntent ğŸ”’
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CREATING_INTENT â”‚  Loading - criando payment intent
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Erro
         â”œâ”€> mostrar erro, voltar para MODAL_OPEN
         â”‚
         â”‚ Sucesso - clientSecret recebido
         â”œâ”€> navigate to CheckoutPage
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ON_CHECKOUT_PAGEâ”‚  Exibindo formulÃ¡rio de cartÃ£o
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ submitPayment()
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONFIRMING      â”‚  Loading - confirmCardPayment
â”‚  PAYMENT         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Erro
         â”œâ”€> mostrar erro, botÃ£o ativo, usuÃ¡rio pode retentar
         â”‚
         â”‚ Sucesso - payment method recebido
         â”œâ”€> processStripePayment mutation
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROCESSING      â”‚  Loading - confirmando no backend
â”‚  BACKEND         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Erro
         â”œâ”€> mostrar erro, botÃ£o ativo, usuÃ¡rio pode retentar
         â”‚
         â”‚ Sucesso - payment confirmado
         â”œâ”€> navigate to OrderConfirmationPage
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONFIRMED       â”‚  âœ“ Pedido pago com sucesso
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ OpÃ§Ã£o 1: [Rastrear Pedido]
         â”‚   â””â”€> OrderTrackingPage
         â”‚
         â””â”€ OpÃ§Ã£o 2: [Continuar Comprando]
             â””â”€> HomePage
```

---

## 6. Fluxo de AutenticaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AUTENTICAÃ‡ÃƒO NO CHECKOUT                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. UsuÃ¡rio NÃƒO autenticado tenta checkout                  â”‚
â”‚     â”œâ”€ CartPage verifica isAuthenticated                    â”‚
â”‚     â”œâ”€ isAuthenticated = false                              â”‚
â”‚     â””â”€ Redireciona para /login                              â”‚
â”‚        â”œâ”€ Passa state: { from: '/cart' }                    â”‚
â”‚        â””â”€ Mensagem: "FaÃ§a login para continuar"             â”‚
â”‚                                                              â”‚
â”‚  2. LoginPage                                                â”‚
â”‚     â”œâ”€ UsuÃ¡rio faz login OU cadastro                        â”‚
â”‚     â”œâ”€ Recebe JWT token                                     â”‚
â”‚     â”œâ”€ Armazena em localStorage                             â”‚
â”‚     â”œâ”€ AuthContext atualiza: isAuthenticated = true         â”‚
â”‚     â””â”€ Redireciona para state.from (/cart)                  â”‚
â”‚                                                              â”‚
â”‚  3. Retorno ao CartPage                                      â”‚
â”‚     â”œâ”€ isAuthenticated = true âœ…                             â”‚
â”‚     â”œâ”€ user dados disponÃ­veis                               â”‚
â”‚     â””â”€ Pode abrir CheckoutModal agora                       â”‚
â”‚                                                              â”‚
â”‚  4. Durante Checkout (todas mutations)                       â”‚
â”‚     â”œâ”€ JWT Token enviado no header                          â”‚
â”‚     â”œâ”€ Authorization: "Bearer <token>"                      â”‚
â”‚     â”œâ”€ Backend valida token                                 â”‚
â”‚     â”œâ”€ Extrai userId do token                               â”‚
â”‚     â””â”€ Associa operaÃ§Ã£o ao usuÃ¡rio                          â”‚
â”‚                                                              â”‚
â”‚  5. Rotas Protegidas                                         â”‚
â”‚     â”œâ”€ /checkout/:orderId â†’ PrivateRoute                    â”‚
â”‚     â”œâ”€ /order-confirmation/:orderId â†’ PrivateRoute          â”‚
â”‚     â”œâ”€ /orders â†’ PrivateRoute                               â”‚
â”‚     â””â”€ Cada uma verifica isAuthenticated                    â”‚
â”‚                                                              â”‚
â”‚  6. PersistÃªncia da SessÃ£o                                   â”‚
â”‚     â”œâ”€ Token em localStorage                                â”‚
â”‚     â”œâ”€ VÃ¡lido atÃ© expiraÃ§Ã£o                                 â”‚
â”‚     â”œâ”€ AuthProvider recarrega em mount                      â”‚
â”‚     â””â”€ Refresh token para renovaÃ§Ã£o                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BENEFÃCIOS DA AUTENTICAÃ‡ÃƒO                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  âœ… SeguranÃ§a                                                â”‚
â”‚     â””â”€ Apenas donos podem ver seus pedidos                  â”‚
â”‚                                                              â”‚
â”‚  âœ… Dados PrÃ©-preenchidos                                    â”‚
â”‚     â”œâ”€ Nome, email, telefone do usuÃ¡rio                     â”‚
â”‚     â””â”€ EndereÃ§os salvos disponÃ­veis                         â”‚
â”‚                                                              â”‚
â”‚  âœ… HistÃ³rico de Pedidos                                     â”‚
â”‚     â”œâ”€ /orders mostra todos os pedidos                      â”‚
â”‚     â””â”€ Rastreamento fÃ¡cil                                   â”‚
â”‚                                                              â”‚
â”‚  âœ… ExperiÃªncia Personalizada                                â”‚
â”‚     â”œâ”€ "OlÃ¡, {user.name}!"                                  â”‚
â”‚     â””â”€ RecomendaÃ§Ãµes baseadas em compras                    â”‚
â”‚                                                              â”‚
â”‚  âœ… Suporte ao Cliente                                       â”‚
â”‚     â”œâ”€ IdentificaÃ§Ã£o fÃ¡cil                                  â”‚
â”‚     â””â”€ HistÃ³rico de interaÃ§Ãµes                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Tipos de Erro e Fluxo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de AutenticaÃ§Ã£o ğŸ”’             â”‚
â”‚  - Token invÃ¡lido                    â”‚
â”‚  - Token expirado                    â”‚
â”‚  - Sem token                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Limpar estado + redirect login â”‚
â”‚ UsuÃ¡rio pode: Fazer login novamente â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de AutorizaÃ§Ã£o ğŸ”’              â”‚
â”‚  - Tentando acessar pedido de outro  â”‚
â”‚  - EndereÃ§o nÃ£o pertence ao usuÃ¡rio  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Erro 403 + mensagem            â”‚
â”‚ UsuÃ¡rio pode: Contatar suporte       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de ValidaÃ§Ã£o (Frontend)        â”‚
â”‚  - EndereÃ§o nÃ£o selecionado          â”‚
â”‚  - Notas muito longas                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Mostrar mensagem no campo      â”‚
â”‚ UsuÃ¡rio pode: Corrigir e retentar   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de Rede (GraphQL)              â”‚
â”‚  - Servidor offline                  â”‚
â”‚  - Timeout                           â”‚
â”‚  - CORS error                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Toast error global             â”‚
â”‚ UsuÃ¡rio pode: Retentar               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de CartÃ£o (Stripe)             â”‚
â”‚  - CartÃ£o recusado                   â”‚
â”‚  - CartÃ£o expirado                   â”‚
â”‚  - CVC invÃ¡lido                      â”‚
â”‚  - Fundos insuficientes              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Mostrar mensagem do Stripe     â”‚
â”‚ UsuÃ¡rio pode: Tentar outro cartÃ£o   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Erro de Backend (ProcessPayment)    â”‚
â”‚  - Payment intent nÃ£o encontrado     â”‚
â”‚  - Pedido nÃ£o encontrado             â”‚
â”‚  - ValidaÃ§Ã£o de seguranÃ§a falhou     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AÃ§Ã£o: Toast error + supportar suporteâ”‚
â”‚ UsuÃ¡rio pode: Contatar suporte       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Matriz de Componentes Ã— Props

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CheckoutModal ğŸ”’ Requer AutenticaÃ§Ã£o                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Props:                                                       â”‚
â”‚  - isOpen: boolean                                           â”‚
â”‚  - onClose: () => void                                       â”‚
â”‚  - onSubmit: (data: CheckoutInput) => void                   â”‚
â”‚  - loading: boolean                                          â”‚
â”‚  - error: string | null                                      â”‚
â”‚  - total: number                                             â”‚
â”‚  - items: CartItem[]                                         â”‚
â”‚                                                              â”‚
â”‚ Hooks:                                                       â”‚
â”‚  - useAuth() â†’ { user, isAuthenticated } ğŸ”’                  â”‚
â”‚  - useQuery(GET_MY_ADDRESSES) ğŸ”’                             â”‚
â”‚                                                              â”‚
â”‚ State:                                                       â”‚
â”‚  - selectedAddressId: string                                 â”‚
â”‚  - notes: string                                             â”‚
â”‚  - errors: Record<string, string>                            â”‚
â”‚                                                              â”‚
â”‚ PrÃ©-carregado:                                               â”‚
â”‚  - user.name (exibido, nÃ£o editÃ¡vel)                         â”‚
â”‚  - user.email (exibido, nÃ£o editÃ¡vel)                        â”‚
â”‚  - user.phone (exibido, nÃ£o editÃ¡vel)                        â”‚
â”‚  - addresses[] (lista para seleÃ§Ã£o)                          â”‚
â”‚                                                              â”‚
â”‚ Handlers:                                                    â”‚
â”‚  - handleAddressSelect, handleSubmit, validate()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OrderSummary                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Props:                                                       â”‚
â”‚  - order: Order (com relacionamento user)                    â”‚
â”‚  - loading?: boolean                                         â”‚
â”‚                                                              â”‚
â”‚ Computed:                                                    â”‚
â”‚  - subtotal (soma totalPrice dos items)                      â”‚
â”‚  - shipping (order.shippingCost)                             â”‚
â”‚  - total (subtotal + shipping)                               â”‚
â”‚                                                              â”‚
â”‚ Renderiza:                                                   â”‚
â”‚  - Cliente: {order.user.name} ğŸ”’                             â”‚
â”‚  - NÃºmero do pedido                                          â”‚
â”‚  - Status do pedido                                          â”‚
â”‚  - Data/hora                                                 â”‚
â”‚  - Lista de itens                                            â”‚
â”‚  - EndereÃ§o de entrega                                       â”‚
â”‚  - Totais (3 linhas)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StripePaymentForm                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Props:                                                       â”‚
â”‚  - clientSecret: string                                      â”‚
â”‚  - amount: number                                            â”‚
â”‚  - onSuccess: (paymentIntentId: string) => void              â”‚
â”‚  - loading?: boolean                                         â”‚
â”‚                                                              â”‚
â”‚ Hooks:                                                       â”‚
â”‚  - useStripe() â†’ stripe instance                             â”‚
â”‚  - useElements() â†’ CardElement reference                     â”‚
â”‚                                                              â”‚
â”‚ State:                                                       â”‚
â”‚  - error: string | null                                      â”‚
â”‚  - loading: boolean                                          â”‚
â”‚                                                              â”‚
â”‚ Handlers:                                                    â”‚
â”‚  - handleSubmit() â†’ stripe.confirmCardPayment()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CheckoutPage ğŸ”’ Rota Protegida                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hooks:                                                       â”‚
â”‚  - useAuth() â†’ { user, isAuthenticated, token } ğŸ”’           â”‚
â”‚  - useParams() â†’ orderId                                     â”‚
â”‚  - useLocation() â†’ state                                     â”‚
â”‚  - useNavigate()                                             â”‚
â”‚  - useMutation(PROCESS_STRIPE_PAYMENT) ğŸ”’                    â”‚
â”‚                                                              â”‚
â”‚ Guards:                                                      â”‚
â”‚  - if (!isAuthenticated) â†’ redirect /login                   â”‚
â”‚                                                              â”‚
â”‚ Effects:                                                     â”‚
â”‚  - Validar orderId e state                                   â”‚
â”‚  - Verificar se pedido pertence ao usuÃ¡rio ğŸ”’                â”‚
â”‚  - Redirecionar se invÃ¡lido ou nÃ£o autorizado                â”‚
â”‚                                                              â”‚
â”‚ Renderiza:                                                   â”‚
â”‚  - Elements (Stripe provider)                                â”‚
â”‚  - Progress stepper                                          â”‚
â”‚  - OrderSummary (direita) com dados do usuÃ¡rio               â”‚
â”‚  - StripePaymentForm (esquerda)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PrivateRoute (HOC) ğŸ”’                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Props:                                                       â”‚
â”‚  - children: ReactNode (componente a proteger)               â”‚
â”‚                                                              â”‚
â”‚ Hooks:                                                       â”‚
â”‚  - useAuth() â†’ { isAuthenticated }                           â”‚
â”‚  - useLocation() â†’ location (para preservar `from`)          â”‚
â”‚                                                              â”‚
â”‚ LÃ³gica:                                                      â”‚
â”‚  - if (!isAuthenticated)                                     â”‚
â”‚    â””â”€ <Navigate to="/login" state={{ from: location }} />   â”‚
â”‚  - else                                                      â”‚
â”‚    â””â”€ {children}                                             â”‚
â”‚                                                              â”‚
â”‚ Uso:                                                         â”‚
â”‚  <Route path="/checkout/:id" element={                       â”‚
â”‚    <PrivateRoute><CheckoutPage /></PrivateRoute>            â”‚
â”‚  } />                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Mapa de SeguranÃ§a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FRONTEND SECURITY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ âœ“ AutenticaÃ§Ã£o JWT ğŸ”’                                        â”‚
â”‚   â†’ Token armazenado em localStorage                         â”‚
â”‚   â†’ Enviado em todas as requisiÃ§Ãµes protegidas              â”‚
â”‚   â†’ Validado pelo backend                                   â”‚
â”‚                                                              â”‚
â”‚ âœ“ Rotas Protegidas (PrivateRoute) ğŸ”’                         â”‚
â”‚   â†’ Verifica isAuthenticated antes de renderizar            â”‚
â”‚   â†’ Redireciona para /login se nÃ£o autenticado              â”‚
â”‚   â†’ Preserva intenÃ§Ã£o de navegaÃ§Ã£o (state.from)             â”‚
â”‚                                                              â”‚
â”‚ âœ“ CardElement do Stripe                                      â”‚
â”‚   â†’ NÃ£o permite acesso aos dados do cartÃ£o                   â”‚
â”‚   â†’ Dados enviados diretamente para Stripe                   â”‚
â”‚                                                              â”‚
â”‚ âœ“ ClientSecret verificado                                    â”‚
â”‚   â†’ Gerado pelo backend (apenas para usuÃ¡rio autenticado)    â”‚
â”‚   â†’ VÃ¡lido apenas para este pagamento                        â”‚
â”‚   â†’ Associado ao userId                                      â”‚
â”‚                                                              â”‚
â”‚ âœ“ TypeScript strict mode                                     â”‚
â”‚   â†’ Sem tipo 'any'                                           â”‚
â”‚   â†’ ValidaÃ§Ã£o de tipos em tempo de compilaÃ§Ã£o                â”‚
â”‚                                                              â”‚
â”‚ âœ“ ValidaÃ§Ã£o de inputs                                        â”‚
â”‚   â†’ Verificar endereÃ§o selecionado                           â”‚
â”‚   â†’ Validar ownership (addressId do usuÃ¡rio)                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND SECURITY                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ âœ“ ValidaÃ§Ã£o JWT em TODAS mutations/queries protegidas ğŸ”’     â”‚
â”‚   â†’ Verificar assinatura do token                           â”‚
â”‚   â†’ Verificar expiraÃ§Ã£o                                     â”‚
â”‚   â†’ Extrair userId do payload                               â”‚
â”‚                                                              â”‚
â”‚ âœ“ AutorizaÃ§Ã£o de Recursos ğŸ”’                                 â”‚
â”‚   â†’ Verificar se pedido pertence ao usuÃ¡rio                 â”‚
â”‚   â†’ Verificar se endereÃ§o pertence ao usuÃ¡rio               â”‚
â”‚   â†’ Bloquear acesso a recursos de outros usuÃ¡rios           â”‚
â”‚                                                              â”‚
â”‚ âœ“ ValidaÃ§Ã£o de backend                                       â”‚
â”‚   â†’ Validar todos inputs novamente                           â”‚
â”‚   â†’ NÃ£o confiar apenas em validaÃ§Ã£o do frontend              â”‚
â”‚   â†’ Validar relacionamentos (order -> user)                  â”‚
â”‚                                                              â”‚
â”‚ âœ“ VerificaÃ§Ã£o de Stripe                                      â”‚
â”‚   â†’ Validar paymentIntent com Stripe API                     â”‚
â”‚   â†’ Confirmar que pagamento foi bem-sucedido                 â”‚
â”‚   â†’ Verificar valor corresponde ao pedido                    â”‚
â”‚                                                              â”‚
â”‚ âœ“ AutenticaÃ§Ã£o de API                                        â”‚
â”‚   â†’ Usar chave secreta (sk_test_...)                         â”‚
â”‚   â†’ NUNCA expor chave secreta no frontend                    â”‚
â”‚                                                              â”‚
â”‚ âœ“ Rate limiting por usuÃ¡rio ğŸ”’                               â”‚
â”‚   â†’ Limitar tentativas de pagamento por userId               â”‚
â”‚   â†’ Prevenir abuse e fraude                                  â”‚
â”‚   â†’ Bloquear usuÃ¡rios suspeitos                              â”‚
â”‚                                                              â”‚
â”‚ âœ“ Logging & Monitoring por usuÃ¡rio ğŸ”’                        â”‚
â”‚   â†’ Registrar todas as transaÃ§Ãµes com userId                 â”‚
â”‚   â†’ Alertar sobre atividades suspeitas                       â”‚
â”‚   â†’ Auditoria completa de aÃ§Ãµes                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMUNICAÃ‡ÃƒO SEGURA                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ âœ“ HTTPS em produÃ§Ã£o                                          â”‚
â”‚   â†’ Criptografia end-to-end                                  â”‚
â”‚   â†’ Prevenir man-in-the-middle attacks                       â”‚
â”‚                                                              â”‚
â”‚ âœ“ CORS configurado                                           â”‚
â”‚   â†’ Apenas domÃ­nios autorizados                              â”‚
â”‚   â†’ Prevenir requisiÃ§Ãµes cross-origin nÃ£o autorizadas        â”‚
â”‚                                                              â”‚
â”‚ âœ“ CSP (Content Security Policy)                              â”‚
â”‚   â†’ Whitelist de recursos                                    â”‚
â”‚   â†’ Prevenir injection attacks                               â”‚
â”‚                                                              â”‚
â”‚ âœ“ JWT tokens                                                 â”‚
â”‚   â†’ AutenticaÃ§Ã£o para usuÃ¡rios logados                       â”‚
â”‚   â†’ RenovaÃ§Ã£o segura de tokens                               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Performance Metrics

```
Targets:
â”‚
â”œâ”€ Page Load: < 2000ms
â”‚  â”œâ”€ HTML: 200ms
â”‚  â”œâ”€ CSS: 300ms
â”‚  â”œâ”€ JS Bundle: 800ms
â”‚  â””â”€ Stripe.js: 400ms
â”‚
â”œâ”€ GraphQL Query: < 500ms
â”‚  â”œâ”€ Network: 100ms
â”‚  â””â”€ Backend processing: 400ms
â”‚
â”œâ”€ Stripe confirmCardPayment: < 2000ms
â”‚  â”œâ”€ Network: 500ms
â”‚  â””â”€ Stripe processing: 1500ms
â”‚
â””â”€ Total Checkout: < 5000ms
   â”œâ”€ Modal: 1000ms
   â”œâ”€ Create order: 800ms
   â”œâ”€ Create intent: 500ms
   â”œâ”€ Payment: 2000ms
   â””â”€ Confirmation page: 700ms
```

---

**Diagrama Visual Completo do Checkout Stripe com AutenticaÃ§Ã£o ObrigatÃ³ria** âœ…

---

## âš ï¸ IMPORTANTE: MudanÃ§a de Arquitetura

### âŒ VersÃ£o Anterior (Descontinuada)
- Checkout anÃ´nimo (`guestCheckout`)
- Rastreamento por token pÃºblico
- Sem vÃ­nculo com usuÃ¡rio

### âœ… VersÃ£o Atual (Implementada)
- **AutenticaÃ§Ã£o obrigatÃ³ria** para checkout
- UsuÃ¡rio deve estar logado
- Pedidos vinculados ao userId
- Dados prÃ©-carregados do perfil
- EndereÃ§os salvos reutilizÃ¡veis
- HistÃ³rico completo em /orders

### ğŸ”’ SeguranÃ§a Aprimorada
- JWT Token em todas as operaÃ§Ãµes
- ValidaÃ§Ã£o de ownership (pedido pertence ao usuÃ¡rio)
- AutorizaÃ§Ã£o granular (endereÃ§o pertence ao usuÃ¡rio)
- Auditoria completa por usuÃ¡rio
- Rate limiting por userId

### ğŸ“‹ Requisitos para Checkout
1. âœ… UsuÃ¡rio deve ter conta (register)
2. âœ… UsuÃ¡rio deve estar logado (login)
3. âœ… UsuÃ¡rio deve ter pelo menos 1 endereÃ§o cadastrado
4. âœ… JWT Token vÃ¡lido no localStorage

### ğŸ”„ Fluxo Atualizado
```
Sem Login â†’ Adicionar produto â†’ Tentar checkout â†’ Redirect /login
                                                        â†“
                                                    Login/Register
                                                        â†“
                                                  Volta ao cart
                                                        â†“
                                                   Checkout âœ…
```
